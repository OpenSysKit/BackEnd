name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta:
    name: 版本信息
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 解析版本
        id: set_tag
        run: |
          tag="${{ github.ref_name }}"
          is_release=${{ startsWith(github.ref, 'refs/tags/v') }}

          if ! $is_release; then
            tag="$(date +v0.0.0-%y%m%d-$(git rev-parse --short HEAD))"
          fi

          is_prerelease=false
          if [[ $tag =~ .*alpha.* || $tag =~ .*beta.* || $tag =~ .*rc.* || $tag =~ .*dev.* ]]; then
            is_prerelease=true
          fi

          echo "tag=$tag" | tee -a $GITHUB_OUTPUT
          echo "is_release=$is_release" | tee -a $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" | tee -a $GITHUB_OUTPUT

    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      is_release: ${{ steps.set_tag.outputs.is_release }}
      is_prerelease: ${{ steps.set_tag.outputs.is_prerelease }}

  build:
    name: 构建 (${{ matrix.arch }})
    needs: meta
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: 拉取最新驱动
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $driverArch = if ("${{ matrix.arch }}" -eq "arm64") { "ARM64" } else { "x64" }
          $release = gh release view --repo OpenSysKit/Driver --json tagName,assets | ConvertFrom-Json
          Write-Host "驱动版本: $($release.tagName)"
          New-Item -ItemType Directory -Force -Path driver | Out-Null
          foreach ($asset in $release.assets) {
            if ($asset.name -like "*$driverArch*") {
              gh release download $release.tagName --repo OpenSysKit/Driver --pattern $asset.name --dir driver
              Expand-Archive -Path "driver/$($asset.name)" -DestinationPath driver -Force
            }
          }

      - name: 编译
        shell: pwsh
        env:
          GOOS: windows
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: "0"
        run: |
          $cst = [System.TimeZoneInfo]::FindSystemTimeZoneById("China Standard Time")
          $buildTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $cst).ToString("yyyy-MM-dd HH:mm:ss")
          $ldflags = "-s -w -X 'main.version=${{ needs.meta.outputs.tag }}' -X 'main.buildTime=$buildTime'"
          go build -ldflags $ldflags -trimpath -o OpenSysKit.exe ./cmd/server

      - name: 打包
        shell: pwsh
        run: |
          $files = @("OpenSysKit.exe")
          $sysFiles = Get-ChildItem -Path driver -Filter "*.sys" -Recurse -ErrorAction SilentlyContinue
          foreach ($f in $sysFiles) { $files += $f.FullName }
          Compress-Archive -Path $files -DestinationPath "OpenSysKit-win-${{ matrix.arch }}-${{ needs.meta.outputs.tag }}.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: OpenSysKit-win-${{ matrix.arch }}
          path: "OpenSysKit-win-${{ matrix.arch }}-${{ needs.meta.outputs.tag }}.zip"

  changelog:
    name: 生成更新日志
    needs: meta
    if: ${{ needs.meta.outputs.is_release == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 生成 changelog
        id: changelog
        uses: orhun/git-cliff-action@v4
        with:
          args: -vv --latest --strip header
        env:
          OUTPUT: CHANGES.md
          GITHUB_REPO: ${{ github.repository }}

    outputs:
      release_body: ${{ steps.changelog.outputs.content }}

  release:
    name: 发布
    if: ${{ needs.meta.outputs.is_release == 'true' }}
    needs: [meta, build, changelog]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: OpenSysKit-*
          path: artifacts
          merge-multiple: true

      - name: 发布 Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.zip
          tag_name: ${{ needs.meta.outputs.tag }}
          body: ${{ needs.changelog.outputs.release_body }}
          draft: false
          prerelease: ${{ needs.meta.outputs.is_prerelease == 'true' }}
